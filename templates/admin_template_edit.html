{% extends "base.html" %}

{% block title %}编辑模板 - 文档评审系统{% endblock %}

{% block content %}
<div class="page-header">
    <h1>编辑模板：{{ template.name }}</h1>
    <div class="header-actions">
        <button id="edit-mode-btn" class="btn btn-primary" onclick="toggleEditMode()">编辑</button>
    </div>
</div>

<div class="section">
    <h2>维度列表</h2>
    <div id="dimensions-view-mode">
        <div class="table-container">
            <table class="data-table dimensions-view-table" style="table-layout: fixed; width: 100%;">
                <colgroup>
                    <col style="width: 25%;">
                    <col style="width: 25%;">
                    <col style="width: 50%;">
                </colgroup>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>权重</th>
                        <th>描述</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in dimensions_list|sort(attribute='order_index') %}
                    <tr>
                        <td class="name-cell" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.6;">{{ d.name }}</td>
                        <td>{{ '%.2f' % d.weight }}</td>
                        <td class="description-cell" style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.6;">{{ d.description or '-' }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center">暂无维度</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="dimensions-edit-mode" style="display: none;">
        <form id="dimensions-form" method="POST" action="{{ url_for('admin_template_edit', tpl_id=template.id) }}">
            <input type="hidden" name="action" value="batch_update">
            <div id="dimensions-list" class="dimensions-editable-list">
                {% for d in dimensions_list|sort(attribute='order_index') %}
                <div class="dimension-item" data-dim-id="{{ d.id }}">
                    <input type="hidden" name="dim_ids" value="{{ d.id }}">
                    <div class="dimension-fields">
                        <div class="dimension-field">
                            <label>维度名称 *</label>
                            <input type="text" name="dim_names" value="{{ d.name }}" required>
                        </div>
                        <div class="dimension-field dimension-weight">
                            <label>权重 *</label>
                            <input type="number" name="dim_weights" value="{{ '%.2f' % d.weight }}" step="0.01" min="0" max="1" required oninput="updateWeightTotal()">
                        </div>
                        <div class="dimension-field">
                            <label>维度描述</label>
                            <textarea name="dim_descs">{{ d.description or '' }}</textarea>
                        </div>
                    </div>
                    <div class="dimension-actions">
                        <button type="button" class="btn btn-sm btn-text" onclick="moveDimensionUp(this)">上移</button>
                        <button type="button" class="btn btn-sm btn-text" onclick="moveDimensionDown(this)">下移</button>
                        <button type="button" class="btn btn-sm btn-text" onclick="removeDimension(this)">删除</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 1rem;">
                <button type="button" class="btn btn-primary" onclick="addNewDimension()">添加新维度</button>
            </div>
            <div class="weight-summary" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
                <strong>权重总和：<span id="weight-total">0.00</span></strong>
                <span id="weight-error" style="color: #dc3545; margin-left: 1rem; display: none;">权重总和必须等于1.00</span>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary" id="save-btn" {% if not can_edit %}disabled{% endif %}>保存</button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit()">取消</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* 查看模式下的表格样式 */
.dimensions-view-table {
    table-layout: fixed;
    width: 100%;
}

.dimensions-view-table th:nth-child(1),
.dimensions-view-table td:nth-child(1) {
    width: 25%; /* 1fr out of 4fr total */
}

.dimensions-view-table th:nth-child(2),
.dimensions-view-table td:nth-child(2) {
    width: 25%; /* 1fr out of 4fr total */
}

.dimensions-view-table th:nth-child(3),
.dimensions-view-table td:nth-child(3) {
    width: 50%; /* 2fr out of 4fr total */
}

/* 查看模式下的名称单元格样式 */
.name-cell {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.6;
}

/* 查看模式下的描述单元格样式 */
.description-cell {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.6;
}

.dimensions-editable-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.dimension-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.dimension-fields {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr 2fr;
    gap: 1rem;
    align-items: start;
}

.dimension-field {
    display: flex;
    flex-direction: column;
}

.dimension-field label {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    color: var(--dark-text);
}

.dimension-field input,
.dimension-field textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
    font-family: inherit;
    box-sizing: border-box;
}

.dimension-field textarea {
    height: 2.5rem;
    resize: none;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    overflow-y: auto;
    line-height: 1.5;
}

.dimension-weight {
    max-width: 150px;
}

.dimension-actions {
    display: flex;
    flex-direction: row;
    gap: 0.5rem;
    align-items: center;
}

.dimension-actions .btn-text {
    background-color: transparent;
    border: 1px solid #ddd;
    color: inherit;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    text-decoration: none;
    border-radius: 4px;
}

.dimension-actions .btn-text:hover {
    opacity: 0.7;
    border-color: #999;
}

.weight-summary {
    font-size: 1rem;
}

#weight-error {
    font-weight: normal;
}

@media (max-width: 768px) {
    .dimension-fields {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let editMode = false;

function toggleEditMode() {
    editMode = !editMode;
    const viewMode = document.getElementById('dimensions-view-mode');
    const editModeDiv = document.getElementById('dimensions-edit-mode');
    const editBtn = document.getElementById('edit-mode-btn');
    
    if (editMode) {
        viewMode.style.display = 'none';
        editModeDiv.style.display = 'block';
        editBtn.textContent = '取消编辑';
        editBtn.classList.remove('btn-primary');
        editBtn.classList.add('btn-secondary');
        updateWeightTotal();
    } else {
        viewMode.style.display = 'block';
        editModeDiv.style.display = 'none';
        editBtn.textContent = '编辑';
        editBtn.classList.remove('btn-secondary');
        editBtn.classList.add('btn-primary');
    }
}

function addNewDimension() {
    const list = document.getElementById('dimensions-list');
    const newItem = document.createElement('div');
    newItem.className = 'dimension-item';
    newItem.innerHTML = `
        <input type="hidden" name="dim_ids" value="new">
        <div class="dimension-fields">
            <div class="dimension-field">
                <label>维度名称 *</label>
                <input type="text" name="dim_names" value="" required>
            </div>
            <div class="dimension-field dimension-weight">
                <label>权重 *</label>
                <input type="number" name="dim_weights" value="0.00" step="0.01" min="0" max="1" required oninput="updateWeightTotal()">
            </div>
            <div class="dimension-field">
                <label>维度描述</label>
                <textarea name="dim_descs"></textarea>
            </div>
        </div>
        <div class="dimension-actions">
            <button type="button" class="btn btn-sm btn-text" onclick="moveDimensionUp(this)">上移</button>
            <button type="button" class="btn btn-sm btn-text" onclick="moveDimensionDown(this)">下移</button>
            <button type="button" class="btn btn-sm btn-text" onclick="removeDimension(this)">删除</button>
        </div>
    `;
    list.appendChild(newItem);
    
    // 为新输入框添加事件监听
    const weightInput = newItem.querySelector('input[name="dim_weights"]');
    weightInput.addEventListener('input', updateWeightTotal);
    
    updateWeightTotal();
}

function moveDimensionUp(btn) {
    const item = btn.closest('.dimension-item');
    const prevItem = item.previousElementSibling;
    if (prevItem) {
        item.parentNode.insertBefore(item, prevItem);
        updateWeightTotal();
    }
}

function moveDimensionDown(btn) {
    const item = btn.closest('.dimension-item');
    const nextItem = item.nextElementSibling;
    if (nextItem) {
        item.parentNode.insertBefore(nextItem, item);
        updateWeightTotal();
    }
}

function removeDimension(btn) {
    const item = btn.closest('.dimension-item');
    item.remove();
    updateWeightTotal();
}

function updateWeightTotal() {
    const weightInputs = document.querySelectorAll('input[name="dim_weights"]');
    let total = 0;
    weightInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    const totalSpan = document.getElementById('weight-total');
    const errorSpan = document.getElementById('weight-error');
    const saveBtn = document.getElementById('save-btn');
    
    totalSpan.textContent = total.toFixed(2);
    
    if (Math.abs(total - 1.0) > 0.01) {
        errorSpan.style.display = 'inline';
        saveBtn.disabled = true;
        saveBtn.style.opacity = '0.5';
        saveBtn.style.cursor = 'not-allowed';
    } else {
        errorSpan.style.display = 'none';
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';
        saveBtn.style.cursor = 'pointer';
    }
}

function cancelEdit() {
    if (confirm('确定要取消编辑吗？未保存的更改将丢失。')) {
        location.reload();
    }
}

    // 为所有权重输入框添加事件监听
    document.addEventListener('DOMContentLoaded', function() {
        const weightInputs = document.querySelectorAll('input[name="dim_weights"]');
    weightInputs.forEach(input => {
        input.addEventListener('input', updateWeightTotal);
    });
    
    // 表单提交验证
    document.getElementById('dimensions-form').addEventListener('submit', function(e) {
        updateWeightTotal();
        const total = parseFloat(document.getElementById('weight-total').textContent);
        if (Math.abs(total - 1.0) > 0.01) {
            e.preventDefault();
            alert('权重总和必须等于1.00，当前总和为：' + total.toFixed(2));
            return false;
        }
    });
});
</script>
{% endblock %}


