<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}文档评审系统{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="{{ url_for('dashboard') }}">文档评审系统</a>
            </div>
            <div class="nav-menu">
                {% if current_user.is_authenticated %}
                    <span class="nav-user">欢迎, {{ current_user.username }} ({{ '管理员' if current_user.is_admin() else ( '教师' if current_user.role=='teacher' else '评审者') }})</span>
                    {% if current_user.is_admin() %}
                        <a href="{{ url_for('user_management') }}" class="nav-link">用户管理</a>
                        <a href="{{ url_for('admin_templates') }}" class="nav-link">评分模板</a>
                        <a href="{{ url_for('admin_events') }}" class="nav-link">评审活动</a>
                    {% endif %}
                    <a href="{{ url_for('edit_user', user_id=current_user.id) }}" class="nav-link">个人设置</a>
                    <a href="{{ url_for('logout') }}" class="nav-link">退出</a>
                {% else %}
                    <a href="{{ url_for('login') }}" class="nav-link">登录</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                {{ message }}
                                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            {% block back_button %}
            {% if request.path != '/' and request.path != '/login' and request.path != '/register' and request.path != '/dashboard' and request.path != '/complete-profile' %}
            <div class="back-button-container">
                {% if current_user.is_authenticated %}
                    {# 二级页面：返回主页面 #}
                    {% if request.path == '/users' or request.path == '/admin/templates' or request.path == '/admin/events' %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {# 个人设置（二级页面）：返回主页面 #}
                    {% elif request.path.startswith('/user/') and '/edit' in request.path and request.path.count('/') == 3 %}
                        {% set path_parts = request.path.split('/') %}
                        {% if path_parts|length >= 3 and path_parts[2]|int == current_user.id %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-back" title="返回">
                            返回
                        </a>
                        {% else %}
                        <a href="{{ url_for('user_management') }}" class="btn btn-secondary btn-back" title="返回">
                            返回
                        </a>
                        {% endif %}
                    {# 三级页面：返回对应的二级页面 #}
                    {% elif request.path == '/admin/create_user' %}
                    <a href="{{ url_for('user_management') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% elif request.path == '/admin/templates/create' or (request.path.startswith('/admin/templates/') and request.path.count('/') == 4 and not request.path.endswith('/delete')) %}
                    <a href="{{ url_for('admin_templates') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% elif request.path == '/admin/events/create' or (request.path.startswith('/admin/events/') and request.path.count('/') == 4 and '/edit' in request.path) %}
                    <a href="{{ url_for('admin_events') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% elif request.path.startswith('/admin/events/') and request.path.count('/') == 4 and '/documents' in request.path %}
                    {# 从管理员首页进入的活动文档列表，返回首页；从活动列表进入的，返回活动列表 #}
                    {% set from_param = request.args.get('from', '') %}
                    {% if request.args.get('from') == 'dashboard' or (from_param is defined and from_param == 'dashboard') %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% else %}
                    <a href="{{ url_for('admin_events') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% endif %}
                    {% elif request.path.startswith('/admin/events/') and request.path.count('/') == 4 and '/visibility' in request.path %}
                    <a href="{{ url_for('admin_events') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% elif request.path.startswith('/teacher/event/') or request.path.startswith('/reviewer/event/') %}
                    {# 教师和评审员的活动详情页：返回到活动选择页面（dashboard） #}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% elif request.path.startswith('/document/') %}
                    {# 文档详情页：使用传递的back_url #}
                    {% if back_url is defined and back_url %}
                    <a href="{{ back_url }}" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% else %}
                    <a href="javascript:history.back()" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% endif %}
                    {% else %}
                    <a href="javascript:history.back()" class="btn btn-secondary btn-back" title="返回">
                        返回
                    </a>
                    {% endif %}
                {% else %}
                <a href="javascript:history.back()" class="btn btn-secondary btn-back" title="返回">
                    返回
                </a>
                {% endif %}
            </div>
            {% endif %}
            {% endblock %}
            
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 文档评审系统. All rights reserved.</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>

